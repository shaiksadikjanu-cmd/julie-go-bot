<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Julu AI (Go Edition)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    
    <style>
        /* --- CSS FROM YOUR FILE --- */
        :root {
            --bg-color: #f0f2f5; --header-bg: #ffffff; --text-color: #111111;
            --panel-bg: #ffffff; --panel-border: #ddd; --input-bg: #ffffff;
            --user-bubble: #007bff; --user-text: #ffffff; --bot-bubble: #ffffff;
            --active-chat: #e6f2ff; --select-bg: #f8f9fa; --modal-bg: #ffffff;
            --success: #00b894; --danger: #d63031; --menu-bg: #ffffff; --menu-shadow: rgba(0,0,0,0.15);
        }
        [data-theme='dark'] {
            --bg-color: #121212; --header-bg: #1f1f1f; --text-color: #e0e0e0;
            --panel-bg: #1f1f1f; --panel-border: #333; --input-bg: #2d2d2d;
            --bot-bubble: #2d2d2d; --active-chat: #333; --select-bg: #2d2d2d;
            --modal-bg: #2d2d2d; --menu-bg: #2d2d2d; --menu-shadow: rgba(0,0,0,0.5);
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; height: 100vh; overflow: hidden; }
        .app-container { height: 100%; display: flex; flex-direction: column; background-color: var(--bg-color); color: var(--text-color); transition: background 0.3s; }
        
        /* HEADER & SIDE PANEL */
        .app-header { padding: 15px 20px; background: var(--header-bg); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--panel-border); z-index: 10; }
        .header-title { margin: 0; font-size: 1.5rem; }
        .model-badge { font-size: 10px; background: var(--panel-border); padding: 2px 6px; border-radius: 4px; margin-left: 10px; color: var(--text-color); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; display: none; }
        .side-panel { position: fixed; top: 0; right: 0; width: 300px; height: 100%; background: var(--panel-bg); transition: transform 0.3s; z-index: 100; display: flex; flex-direction: column; border-left: 1px solid var(--panel-border); transform: translateX(100%); }
        .side-panel.open { transform: translateX(0); }
        .panel-header { padding: 20px; border-bottom: 1px solid var(--panel-border); display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .settings-container { padding: 15px; border-bottom: 1px solid var(--panel-border); }
        .settings-label { display: block; margin-bottom: 8px; font-weight: bold; opacity: 0.8; font-size: 14px; }
        .select-input { width: 90%; padding: 10px; border-radius: 8px; border: 1px solid var(--panel-border); background: var(--select-bg); color: var(--text-color); outline: none; }
        .history-list { flex: 1; overflow-y: auto; padding: 10px; }
        .history-item { padding: 12px; border-radius: 10px; margin-bottom: 8px; cursor: pointer; display: flex; justify-content: space-between; color: var(--text-color); }
        .history-item.active { background: var(--active-chat); }
        .theme-toggle { margin: 20px; padding: 10px; border-radius: 10px; border: 1px solid var(--panel-border); background: transparent; color: var(--text-color); cursor: pointer; }

        /* CHAT AREA */
        .chat-list { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .message-row { display: flex; width: 100%; }
        .message-row.user { justify-content: flex-end; }
        .message-row.bot { justify-content: flex-start; }
        .message-bubble { padding: 12px 18px; border-radius: 15px; max-width: 80%; box-shadow: 0 1px 2px rgba(0,0,0,0.1); line-height: 1.5; word-wrap: break-word; position: relative; }
        .message-bubble.user { background: var(--user-bubble); color: var(--user-text); border-bottom-right-radius: 2px; }
        .message-bubble.bot { background: var(--bot-bubble); color: var(--text-color); border-bottom-left-radius: 2px; }
        
        /* IMAGES & BUTTONS */
        .message-image { max-width: 100%; border-radius: 10px; margin-bottom: 10px; display: block; }
        .speak-btn { background: none; border: none; font-size: 16px; cursor: pointer; opacity: 0.5; margin-left: 10px; vertical-align: middle; }
        .speak-btn:hover { opacity: 1; transform: scale(1.1); }
        
        /* MARKDOWN STYLES */
        .message-bubble pre { background: #2d2d2d; color: #fff; padding: 10px; border-radius: 8px; overflow-x: auto; }
        .message-bubble code { font-family: monospace; }
        
        /* MERMAID */
        .mermaid-wrapper { background: white; padding: 10px; border-radius: 8px; margin-top: 10px; display: flex; flex-direction: column; align-items: center; border: 1px solid var(--panel-border); }
        .download-btn { margin-top: 10px; background-color: #6c5ce7; color: white; border: none; padding: 5px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: opacity 0.2s; align-self: flex-end; }
        
        /* INPUT AREA */
        .input-area { padding: 20px; background: var(--header-bg); display: flex; gap: 10px; border-top: 1px solid var(--panel-border); align-items: center; position: relative; }
        .chat-input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid var(--panel-border); background: var(--input-bg); color: var(--text-color); font-size: 16px; outline: none; }
        .icon-btn { cursor: pointer; background: none; border: none; font-size: 20px; color: var(--text-color); padding: 5px; transition: transform 0.2s; }
        .icon-btn:hover { transform: scale(1.1); }
        .btn { cursor: pointer; padding: 8px 15px; border-radius: 5px; border: none; background: #007bff; color: white; font-weight: bold; }
        
        /* ATTACH MENU */
        .attach-container { position: relative; }
        .plus-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--select-bg); display: flex; justify-content: center; align-items: center; border: 1px solid var(--panel-border); font-size: 24px; font-weight: bold; }
        .attach-menu { position: absolute; bottom: 60px; left: 0; background-color: var(--menu-bg); border: 1px solid var(--panel-border); border-radius: 12px; box-shadow: 0 4px 15px var(--menu-shadow); display: none; flex-direction: column; min-width: 120px; z-index: 50; }
        .attach-menu.show { display: flex; }
        .menu-item { padding: 12px 15px; background: none; border: none; color: var(--text-color); text-align: left; cursor: pointer; border-bottom: 1px solid var(--panel-border); }
        .menu-item:hover { background-color: var(--select-bg); }

        .preview-container { position: absolute; bottom: 80px; left: 60px; background: var(--panel-bg); padding: 5px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); border: 1px solid var(--panel-border); display: none; }
        .preview-container.show { display: block; }
        .preview-img { width: 80px; height: 80px; object-fit: cover; border-radius: 5px; }
        .remove-preview { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; }

        /* LOADING DOTS */
        .typing-indicator { display: flex; gap: 3px; }
        .typing-dot { width: 8px; height: 8px; background: var(--text-color); opacity: 0.5; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; } .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body>
    <div class="app-container" id="app" data-theme="dark">
        <header class="app-header">
            <div style="display: flex; align-items: center">
                <h2 class="header-title">Julu AI</h2>
                <span class="model-badge">Go + Gemini 1.5</span>
            </div>
            <button class="icon-btn" onclick="togglePanel()">‚ò∞</button>
        </header>

        <div class="overlay" id="overlay" onclick="togglePanel()"></div>
        <div class="side-panel" id="sidePanel">
            <div class="panel-header">
                <span>Settings</span>
                <button class="icon-btn" onclick="togglePanel()">‚úï</button>
            </div>
            
            <div class="settings-container">
                <label class="settings-label">üó£Ô∏è Voice Language:</label>
                <select class="select-input" id="voiceLang">
                    <option value="en-US">English (US)</option>
                    <option value="en-IN">English (India)</option>
                    <option value="te-IN">Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)</option>
                    <option value="hi-IN">Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
                </select>
            </div>

            <div style="padding: 15px">
                <button class="btn" style="width: 100%" onclick="clearChat()">+ New Chat</button>
            </div>
            
            <div class="history-list">
                <div class="history-item active">Current Session</div>
            </div>
            
            <button class="theme-toggle" onclick="toggleTheme()">‚òÄÔ∏è / üåô Toggle Theme</button>
        </div>

        <div class="chat-list" id="chatList">
            <div style="text-align: center; margin-top: 50px; opacity: 0.5">
                <h3>Hi Janu!</h3>
                <p>I am Julu (Go Version).<br>I can see images and speak!</p>
            </div>
        </div>

        <div class="input-area">
            <div class="preview-container" id="previewContainer">
                <img src="" alt="Preview" class="preview-img" id="previewImg">
                <button class="remove-preview" onclick="clearAttachment()">‚úï</button>
            </div>

            <div class="attach-container">
                <button class="icon-btn plus-btn" onclick="toggleAttachMenu()">Ôºã</button>
                <div class="attach-menu" id="attachMenu">
                    <input type="file" id="fileInput" accept="image/*" style="display: none" onchange="handleFileSelect(event)">
                    <button class="menu-item" onclick="document.getElementById('fileInput').click()">üñºÔ∏è Image</button>
                    <button class="menu-item" onclick="toggleVoiceInput()" id="micBtn">üé§ Voice</button>
                </div>
            </div>

            <input type="text" class="chat-input" id="userInput" placeholder="Message..." onkeypress="handleKeyPress(event)">
            <button class="btn" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        // State
        let isDarkMode = true;
        let attachment = null; // Base64 string
        let speechLang = "en-US";
        
        // Init Markdown & Mermaid
        mermaid.initialize({ startOnLoad: true, theme: 'dark' });

        function togglePanel() {
            document.getElementById('sidePanel').classList.toggle('open');
            document.getElementById('overlay').style.display = 
                document.getElementById('sidePanel').classList.contains('open') ? 'block' : 'none';
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.getElementById('app').setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            mermaid.initialize({ startOnLoad: true, theme: isDarkMode ? 'dark' : 'default' });
        }

        function toggleAttachMenu() {
            document.getElementById('attachMenu').classList.toggle('show');
        }

        // --- FILE HANDLING ---
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    attachment = reader.result;
                    document.getElementById('previewImg').src = attachment;
                    document.getElementById('previewContainer').classList.add('show');
                    toggleAttachMenu();
                };
                reader.readAsDataURL(file);
            }
        }

        function clearAttachment() {
            attachment = null;
            document.getElementById('previewContainer').classList.remove('show');
            document.getElementById('fileInput').value = "";
        }

        // --- CHAT LOGIC ---
        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function appendMessage(role, text, image = null) {
            const chatList = document.getElementById('chatList');
            const row = document.createElement('div');
            row.className = `message-row ${role}`;
            
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${role}`;

            if (image) {
                const img = document.createElement('img');
                img.src = image;
                img.className = 'message-image';
                bubble.appendChild(img);
            }

            // Parse Markdown
            if (role === 'bot') {
                // Check for mermaid blocks
                if (text.includes('```mermaid')) {
                    const parts = text.split('```');
                    parts.forEach((part, index) => {
                        if (part.startsWith('mermaid')) {
                            const div = document.createElement('div');
                            div.className = "mermaid-wrapper";
                            div.innerHTML = `<div class="mermaid">${part.replace('mermaid', '')}</div>`;
                            bubble.appendChild(div);
                        } else if (part.trim() !== "") {
                            const span = document.createElement('div');
                            span.innerHTML = marked.parse(part);
                            bubble.appendChild(span);
                        }
                    });
                    setTimeout(() => mermaid.init(), 500); // Re-render diagrams
                } else {
                    bubble.innerHTML = marked.parse(text);
                }
                
                // Add Speak Button
                const btn = document.createElement('button');
                btn.className = 'speak-btn';
                btn.innerText = 'üîä';
                btn.onclick = () => speakText(text);
                bubble.appendChild(btn);

            } else {
                bubble.innerText = text;
            }

            row.appendChild(bubble);
            chatList.appendChild(row);
            chatList.scrollTop = chatList.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const msg = input.value.trim();
            if (!msg && !attachment) return;

            // UI Update
            appendMessage('user', msg, attachment);
            input.value = '';
            
            const currentAttachment = attachment;
            clearAttachment();

            // Loading Indicator
            const chatList = document.getElementById('chatList');
            const loadingRow = document.createElement('div');
            loadingRow.className = 'message-row bot';
            loadingRow.id = 'loading';
            loadingRow.innerHTML = `<div class="message-bubble bot typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
            chatList.appendChild(loadingRow);
            chatList.scrollTop = chatList.scrollHeight;

            try {
                // Send to Go Backend
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg, image: currentAttachment || "" })
                });
                
                const data = await response.json();
                document.getElementById('loading').remove();
                
                if (data.error) {
                    appendMessage('bot', `**Error:** ${data.error}`);
                } else {
                    appendMessage('bot', data.response);
                }
            } catch (err) {
                document.getElementById('loading').remove();
                appendMessage('bot', `**Connection Error:** ${err.message}`);
            }
        }

        function clearChat() {
            document.getElementById('chatList').innerHTML = '<div style="text-align: center; margin-top: 50px; opacity: 0.5"><h3>New Session</h3></div>';
            togglePanel();
        }

        // --- VOICE LOGIC ---
        function speakText(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = document.getElementById('voiceLang').value;
            window.speechSynthesis.speak(utterance);
        }

        function toggleVoiceInput() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) { alert("Browser not supported"); return; }
            
            const recognition = new SpeechRecognition();
            recognition.lang = document.getElementById('voiceLang').value;
            recognition.start();

            const micBtn = document.getElementById('micBtn');
            micBtn.innerText = "üõë Listening...";
            micBtn.style.color = "red";

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('userInput').value += " " + transcript;
                resetMic();
            };

            recognition.onerror = resetMic;
            recognition.onend = resetMic;
        }

        function resetMic() {
            const micBtn = document.getElementById('micBtn');
            micBtn.innerText = "üé§ Voice";
            micBtn.style.color = "var(--text-color)";
            toggleAttachMenu(); // Close menu
        }
    </script>
</body>
</html>